<%- include('partials/header') %>

<section class="page-section events-section">
    <h2 class="section-title">Upcoming Garden Events</h2>
    <p class="section-subtitle">Manage your registered events (MongoDB CRUD demonstration).</p>

    <div class="event-list js-event-list">
        <% events.forEach(event => { %>
            <div class="event-card" data-event-id="<%= event._id %>">
                <h3><%= event.name %></h3>
                <p><strong>Date:</strong> <%= new Date(event.date).toLocaleDateString() %></p>
                <p><strong>Location:</strong> <%= event.location %></p>
                <p><%= event.description %></p>
                <p class="slots-info">Slots Available: <span class="js-slots-<%= event._id %>"><%= event.slots %></span></p>
                <% if (event.slots > 0) { %>
                    <button class="book-btn" onclick="bookSlot('<%= event._id %>')">Book Slot</button>
                <% } else { %>
                    <button class="book-btn full" disabled>Full</button>
                <% } %>
                <button class="delete-btn" onclick="deleteEvent('<%= event._id %>')">Delete</button>
            </div>
        <% }) %>
    </div>
    
    <div class="message-box js-message-box"></div>
</section>

<!-- Client-side script for CRUD interaction -->
<script>
    const messageBox = document.querySelector('.js-message-box');

    function displayMessage(message, isError = false) {
        messageBox.textContent = message;
        messageBox.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
        messageBox.style.color = isError ? '#721c24' : '#155724';
        messageBox.style.display = 'block';
        setTimeout(() => messageBox.style.display = 'none', 3000);
    }

    // Update (U) operation example: Booking a slot
    async function bookSlot(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}/book`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to book slot.');
            }

            const data = await response.json();
            document.querySelector(`.js-slots-${eventId}`).textContent = data.slotsLeft;
            displayMessage('Booked successfully! Slots left: ' + data.slotsLeft);
            if (data.slotsLeft === 0) {
                document.querySelector(`[data-event-id="${eventId}"] .book-btn`).disabled = true;
                document.querySelector(`[data-event-id="${eventId}"] .book-btn`).textContent = 'Full';
            }

        } catch (error) {
            displayMessage(error.message, true);
        }
    }

    // Delete (D) operation example
    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event?')) return;
        
        try {
            const response = await fetch(`/api/events/${eventId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete event.');
            }

            document.querySelector(`[data-event-id="${eventId}"]`).remove();
            displayMessage('Event deleted successfully.');
        } catch (error) {
            displayMessage(error.message, true);
        }
    }
</script>

<%- include('partials/footer') %>